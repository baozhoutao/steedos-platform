### 1.概述
可通过配置权限集及对象权限来实现对不同用户的各种查看/操作权限控制。

### 2.关于权限集
### 2.1.权限集定义
一个权限集指的是一个权限配置单位，每个单位需要指明要约束到的用户范围。
> 默认存在两个权限集，一个是user，指所有用户通用的权限设置，另一个是admin，指所有工作区管理员通用的权限设置。

> 可以根据实际需要添加不同的权限集来表示不同的权限作用范围。

> 同一个用户可能属于多个权限集，比如管理员不但是属于admin这个权限集，也属于user这个权限集。

### 3.1.权限集配置
可为权限集配置以下关联属性：
- users[约束哪些用户]
- assigned_apps[允许查看的应用]
> 默认的user/admin权限集不需要指定users属性，因为其约束的用户范围是固定且不可变更的，但是可以为其指定assigned_apps属性来限制允许查看哪些应用。

### 3.关于对象权限
### 3.1.对象权限定义
每个对象可以配置自己的个性化权限属性，如果某个对象没有配置权限则以默认的权限配置为准。

### 3.2.对象权限配置
可为对象配置以下权限属性：
- allowCreate[是否允许创建记录]
- allowDelete[是否允许删除记录]
- allowEdit[是否允许修改记录]
- allowRead[是否允许查看记录]
- modifyAllRecords[是否允许修改全部记录]
- viewAllRecords [是否允许查看全部记录]
- listviews[允许查看的视图]
- actions[允许查看的操作按钮]
- fields[允许查看的对象字段]
- readonly_fields[只读的对象字段]
- related_objects[相关列表显示哪些列表数据]


全局默认的权限配置:
```
permission_set:
    user:
        allowCreate: true
        allowDelete: true
        allowEdit: true
        allowRead: true
        modifyAllRecords: false
        viewAllRecords: false 
    admin:
        allowCreate: true
        allowDelete: true
        allowEdit: true
        allowRead: true
        modifyAllRecords: true
        viewAllRecords: true 
```

### 4.应用规则

因为同一个用户可能属于多个权限集，所以当前用户的权限需要通过一套规则计算得出，大致规则分为两块。

### 4.1.关于默认权限集
- 虽然有user/admin两个默认权限集，但是对用户来说，只能存在一个默认的权限集，而不可能把两个默认权限集叠加或取交集来得到默认权限集，即如果当前用户是工作区管理员，则取admin为默认权限集，反之取user为默认权限集。
- 程序代码中可以为每个对象的对象属性中配置自己的user/admin默认权限，普通用户也可以通过在权限集中添加user/admin默认权限集，然后再在对象权限中指向该权限集来配置默认权限集。

> 普通用户在对象权限中配置的user/admin默认权限会覆盖程序中代码定义的默认权限。

> 如果对象没有设置任何默认的权限配置，则应用3.2节列出的全局默认权限配置。

### 4.2.通过权限集的优先次序来计算权限规则：
- 适用于allowCreate(允许创建)/allowDelete(允许删除)/allowEdit(允许编辑)/allowRead(查看我的记录)/modifyAllRecords(修改所有记录)/viewAllRecords(查看所有记录)属性，且它们值都是boolean类型。
- 优先次序的应用规则是高优先级别的权限集中任何一个设置为true时直接应用true值，反之为false时，取下一级更低级别的权限集值，直到遇见true值或最低级别的权限集值。
- 优先次序为：非user/admin默认权限集>默认的user/admin权限集。

> 非user/admin默认权限集指的是普通用户在对象权限中配置的非user/admin权限集，同一个用户可能会被分配到多个非user/admin权限集中，这时，只要任何一个权限集中为true，就应用true值，否则应用默认配置，这里可以理解为按true值来叠加设置的意思，即把所有权限集中为true的配置叠加，为false的配置则取低级别即默认的user/admin权限集中的配置。

> 根据上述规则，如果对象默认的admin/user权限集的上述适用属性值为true时，用户通过添加其他权限集配置来把相关属性设置为false是无效的。
比如默认情况下所有对象的user权限集的allowRead为true，那么如果想让某个非管理员用户看不到某个对象，把这个allowRead为false的配置分配到某个非user/admin默认权限集中是无效的，只能把allowRead为false的配置分配到user这个权限集来覆盖默认的user权限集配置。

### 4.3.通过叠加来计算权限规则：
- listviews应该叠加，表示用户在任何一个权限集中配置的视图都显示，如果叠加后为空，则不显示任何视图。
- actions应该叠加，表示用户在任何一个权限集中配置的操作按钮都显示，如果叠加后为空，则不显示任何操作按钮。
- readable_fields 应该叠加，表示用户在任何一个权限集中配置的字段都显示，如果叠加后为空，则不显示任何字段。
- editable_fields 应该叠加，表示用户在任何一个权限集中配置的字段都可编辑，如果叠加后为空，则任何字段都不可编辑。
- related_objects 应该叠加，表示用户在任何一个权限集中配置的相关列表都显示，如果叠加后为空，则不显示任何相关列表。

> 上面描述的“叠加”指的是默认权限集中的配置与用户在权限界面中自定义的一个或多个权限集的权限配置的叠加，但是两个默认的权限集user与admin之间是不会有叠加。

> 4.2中的规则也可以理解为按true值来叠加设置的意思，即把所有权限集中为true的配置叠加。


### 4.4.权限配置属性关联规则
当配置了某个属性后，另一个属性值会自动相应变化，比如modifyAllRecords(修改所有记录)为true时，allowRead/allowEdit/allowDelete/viewAllRecords值都被自动设置为true，详细规则如下：
```
Creator.processPermissions = (po)->
	if po.allowCreate
		po.allowRead = true
	if po.allowEdit
		po.allowRead = true
	if po.allowDelete
		po.allowEdit = true
		po.allowRead = true
	if po.viewAllRecords
		po.allowRead = true
	if po.modifyAllRecords
		po.allowRead = true
		po.allowEdit = true
		po.allowDelete = true
		po.viewAllRecords = true
```

### 5.权限设置方法
#### 先添加一个权限集
![](images/先添加一个权限集.png)

#### 再添加一个对象权限
![](images/再添加一个对象权限.png)

>注意，如果想覆盖admin或user权限集的默认配置，需要先相应的添加一个名称为admin或user的权限集，然后在添加对象权限时，分配其权限集属性为刚新建的admin或user权限集。

### 6.权限相关函数
#### Creator.getObject(object_name).permissions.get() 
获取当前用户某个对象权限计算结果，包括前面提到的所有权限规则属性值。

#### Creator.getPermissions(object_name)
获取当前用户某个对象权限计算结果，包括前面提到的所有权限规则属性值。
- 前台直接返回Creator.getObject(object_name).permissions.get()
- 后台返回Creator.getObjectPermissions函数计算结果 

#### Creator.getObjectPermissions(spaceId, userId, object_name)
后台获取某个用户对某个对象权限计算结果，包括前面提到的所有权限规则属性值，前台没有该函数，但是由Creator.getPermissions函数替换。

#### Creator.getObject(object_name).fields
获取当前用户某个对象所有字段，虽然没有权限的字段也在里面，但是每个字段的权限属性已记录到相关字段属性中，规则如下所示：
- hidden属性表示当前用户没有权限看到该字段
- omit属性与权限无关，所有用户统一不显示该字段
- readonly属性表示当前用户可以看到该字段，但是不可以编辑
- disabled属性与权限无关，所有用户统一不能编辑该字段

#### Creator.getListViews(object_name)
获取当前用户有权限看到某个对象下哪些视图。

#### Creator.getListView(object_name, list_view_id)
获取某个对象下的某个视图，如果没有权限则返回空。

#### Creator.getObject(object_name).list_views
获取当前对象所有的视图，与用户权限无关。

#### Creator.getActions(object_name)
获取当前用户有权限看到某个对象下哪些操作按钮，返回结果为数组，并不是原始Creator.getObject(object_name).actions中的键值队对象形式。

#### Creator.getObject(object_name).actions
获取某个对象所有的操作，与用户权限无关，且返回的结果是键值队对象，不是数组。

#### Creator.getRelatedObjects(object_name)
获取当前用户有权限看到某个对象下的相关对象集合，返回结果为键值队对象元素的数组，其返回值结构参考下面的Creator.getObjectRelateds函数

#### Creator.getRelatedObjectNames(object_name)
获取当前用户有权限看到某个对象下的相关对象名称集合，返回结果为字符串数组，其返回值为上述Creator.getRelatedObjects函数结果中取出object_name属性集合。
> 该函数返回值为_.pluck(Creator.getRelatedObjects函数结果,"object_name")

#### Creator.getObjectRelateds(object_name)
获取某个对象的相关对象信息集合，与用户权限无关，返回结果为键值队对象元素的数组，结构如下所示：
```
[{"object_name":"contacts","foreign_key":"account"},{"object_name":"contracts","foreign_key":"account"},...]
```
> 上述结构中object_name表示关联的对象名称，foreign_key表示关联字段外键字段名
> 该函数只在初始化Object时，把相关对象的计算结果保存到Object的related_objects属性中，后续可以直接从related_objects属性中取得计算结果而不用再次调用该函数来计算。
> 可以通过_.pluck(Creator.getObject(values.object_name).related_objects,"object_name")来得到某个对象下与权限无关的所有相关对象信息集合。

